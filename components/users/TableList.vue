<template>
  <main>
    <div v-if="usersList.length && !loadingUsers"
      class="inline-block min-w-full py-2 align-middle border-gray-100 rounded-b-lg border bg-white shadow">
      <div class="relative">
        <div v-if="selectedPeople.length > 0"
          class="absolute left-14 top-0 flex h-12 items-center space-x-3 bg-white sm:left-12">
          <button type="button"
            class="inline-flex items-center rounded bg-white px-2 py-1 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-30 disabled:hover:bg-white">
            Bulk edit
          </button>
          <button type="button"
            class="inline-flex items-center rounded bg-white px-2 py-1 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-30 disabled:hover:bg-white">
            Delete all
          </button>
        </div>
        <table class="min-w-full table-fixed divide-y divide-gray-300">
          <thead class="">
            <tr>
              <th scope="col" class="relative px-7 sm:w-12 sm:px-6">
                <input type="checkbox"
                  class="absolute left-4 top-1/2 -mt-1 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600"
                  :checked="indeterminate || selectedPeople.length === usersList.length" :indeterminate="indeterminate"
                  @change="selectedPeople = $event.target.checked ? usersList.map((p) => p.email) : []" />
              </th>
              <th scope="col" class="py-3.5 pr-3 text-left text-sm font-semibold text-gray-900">
                Avatar
              </th>
              <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                Username
              </th>
              <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
              FullName
              </th>
              <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
               Auth Provider
              </th>
              <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                Email
              </th>
              <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                Date Created
              </th>
              <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100 bg-white">
            <tr class="odd:bg-gray-50" v-for="(person, index) in usersList" :key="index"
              :class="[selectedPeople.includes(person.email) && 'bg-gray-50']">
              <td class="relative px-7 sm:w-12 sm:px-6">
                <div v-if="selectedPeople.includes(person.email)" class="absolute inset-y-0 left-0 w-0.5 bg-indigo-600">
                </div>
                <input type="checkbox"
                  class="absolute left-4 top-1/2 -mt-1 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600"
                  :value="person.email" v-model="selectedPeople" />
              </td>
              <td :class="[
      'whitespace-nowrap py-4 pr-3 text-xs font-medium',
      selectedPeople.includes(person.email)
        ? 'text-indigo-600'
        : 'text-gray-900',
    ]">
                <DashboardImageZoom v-if="person.profilePicture" class="h-10 w-10" :src="person.profilePicture" />
                <div v-else class="h-10 w-10 rounded-full p-2 bg-gray-500 text-white flex justify-center items-center">
                  {{ generateInitials(person.fname, person.lname) }}
                </div>
              </td>
              <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                <nuxt-link :to="`/dashboard/users/${person.id}`" class="font-medium text-gray-800 no-underline">{{
      person.handle ?? "Nil" }}</nuxt-link>
              </td>
              <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                <nuxt-link class="no-underline text-gray-800" :to="`/dashboard/users/${person.id}`">{{ person.fname ||
      "" }} {{ person.lname ||
        "" }}</nuxt-link>
              </td>
              <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                <nuxt-link class="no-underline text-gray-800" :to="`/dashboard/users/${person.id}`">{{ person.authProvider ||
      "Nil" }}</nuxt-link>
              </td>
              <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                <nuxt-link class="no-underline text-gray-800" :to="`/dashboard/users/${person.id}`">{{ person.email ??
      "Nil" }}</nuxt-link>
              </td>
              <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                <nuxt-link class="no-underline font-semibold text-gray-800" :to="`/dashboard/users/${person.id}`">{{
      moment.utc(person.createdAt).format('MMMM Do YYYY h:mm:ss a') || 'Nil'
    }}
                </nuxt-link>
              </td>
              <td class="whitespace-nowrap text-center py-4 pl-3 pr-4 text-xs font-medium sm:pr-3 relative">
                <button @click="toggleDropdown(index)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" viewBox="0 0 24 24" fill="none"
                    stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="12" cy="5" r="1"></circle>
                    <circle cx="12" cy="19" r="1"></circle>
                  </svg>
                </button>
                <div v-if="openDropdownIndex === index"
                  class="absolute mt-1.5 w-32 bg-white -left-14 rounded-lg shadow-xl z-10">
                  <div>
                    <a href="#" @click.prevent="handleEditUer(person)"
                      class="flex items-center p-3 text-sm text-gray-800 font-semibold capitalize transition-colors duration-300 transform">
                      <span class="mx-1">
                        Edit
                      </span>
                    </a>

                    <a href="#" @click.prevent="handleRemoveUser(person)"
                      class="flex items-center p-3 text-sm text-red-500 font-semibold capitalize transition-colors duration-300 transform">
                      <span class="mx-1">
                        Remove
                      </span>
                    </a>

                    <a href="#" @click.prevent="toggleUserStatus(person)"
                      class="flex items-center p-3 text-sm text-gray-800 font-semibold capitalize transition-colors duration-300 transform">
                      <span class="mx-1">
                        {{ person.isActive ? "Suspend" : "Unsuspend" }}
                      </span>
                    </a>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <CoreBaseModal :show="openRemoveUserModal" @update:show="false">
      <section class="bg-white p-6 space-y-6 max-w-screen-lg rounded-md">
        <div>
          <img src="@/assets/icons/danger.svg" class="h-20 w-20" alt="warning" />
        </div>
        <div>
          <h1 class="font-semibold text-xl">Remove user</h1>
          <p class="text-gray-500">
            Are you sure you want to remove this user? This action cannot be
            undone.
          </p>
        </div>
        <div class="flex justify-end items-end gap-x-3 w-full pt-6">
          <button @click="openRemoveUserModal = false"
            class="text-black text-xs font-medium w-full border-gray-400 border px-3 py-3 rounded-lg">
            Cancel
          </button>
          <button :disabled="processing" @click="proceedToRemove" type="button"
            class="bg-[#D92D20] disabled:cursor-not-allowed disabled:opacity-25 text-sm w-full text-white font-medium px-6 py-3 rounded-lg">
            {{ processing ? "processing..." : "Remove" }}
          </button>
        </div>
      </section>
    </CoreBaseModal>

    <CoreBaseModal :show="updateUserStatusModal" @update:show="updateUserStatusModal = false">
      <section v-if="selectedStatus === 'suspend'" class="bg-white p-6 space-y-6 max-w-screen-lg rounded-md">
        <h1 class="font-semibold text-xl text-gray-900 py-1">Suspend</h1>
        <div class="space-y-6">
          <div class="space-y-2 z-0">
            <label class="font-medium text-gray-800 text-sm">Suspension Category</label>
            <select class="bg-gray-50 rounded-md w-full outline-none py-3 text-sm border-gray-300 border pl-3"
              v-model="form.category">
              <option value="" disabled>Select suspension category</option>
              <option value="male">Bribery</option>
              <option value="female">Corruption</option>
            </select>
          </div>
          <div>
            <label for="Indefinately">
              <input v-model="form.isIndefinately" name="Indefinately" id="Indefinately" type="checkbox" />
              Indefinitely
            </label>
          </div>
          <div class="space-y-2 z-0" v-if="!form.isIndefinately">
            <div class="font-medium text-gray-800 text-sm">Until:</div>
            <vue-tailwind-datepicker class="outline-none ring-0" :formatter="formatter" v-model="form.date" />
          </div>
        </div>
        <div class="flex justify-end items-end gap-x-3 w-full pt-6">
          <button @click="updateUserStatusModal = false" type="button"
            class="text-[#0BA9B9] text-xs font-medium w-full border-gray-400 border px-3 py-3 rounded-lg">
            Cancel
          </button>
          <button :disabled="!isFormEmpty" @click="proceedToSuspendUser" type="button"
            class="bg-[#0BA9B9] text-sm w-full disabled:cursor-not-allowed disabled:opacity-25 text-white font-medium px-6 py-3 rounded-lg">
            Continue
          </button>
        </div>
      </section>
      <section v-if="selectedStatus === 'reactivate'" class="bg-white p-6 space-y-6 max-w-screen-lg rounded-md">
        <div>
          <img src="@/assets/icons/warning.svg" class="h-20 w-20" alt="warning" />
        </div>
        <div>
          <h1 class="font-semibold text-xl">Confirm</h1>
          <p class="text-gray-700">
            Are you sure you want to {{ selectedStatus }} this user?
          </p>
        </div>
        <div class="flex justify-end items-end gap-x-3 w-full pt-6">
          <button @click="updateUserStatusModal = false"
            class="text-black text-xs font-medium w-full border-gray-400 border px-3 py-3 rounded-lg">
            Cancel
          </button>
          <button :disabled="loading" @click="proceedToSuspendUser"
            class="bg-[#0BA9B9] disabled:opacity-25 disabled:cursor-not-allowed text-sm w-full text-white font-medium px-6 py-3 rounded-lg">
            {{ loading ? "processing..." : "Proceed" }}
          </button>
        </div>
      </section>
    </CoreBaseModal>
  </main>
</template>

<script setup lang="ts">
import moment from 'moment'
import VueTailwindDatepicker from "vue-tailwind-datepicker";
import { useUpdateUser } from '@/composables/user/editUser';
import { useDeactivateUser } from '@/composables/user/deactivateUser'
const { deactivateUser, loading } = useDeactivateUser()
const { editUser, loading: editingUser, form: payload } = useUpdateUser()
const selectedPeople = ref([]) as any;
const selectedOption = ref('') as any;
const selectedUser = ref({}) as any
const showEditModal = ref(false) as any
const props = defineProps({
  usersList: {
    type: Array,
    default: () => [],
  },
  loadingUsers: {
    type: Boolean,
    default: false,
  },
});
const formatter = ref({
  date: "DD MMM YYYY",
  month: "MMM",
});

const form = ref({
  category: '',
  isIndefinately: false,
  date: [] as any
})

const isFormEmpty = computed(() => {
  if (form.value.isIndefinately) {
    return !!(form.value.category && form.value.date)
  } else {
    return !!(form.value.category)
  }
})

const handleRemoveUser = (person: any) => {
  openRemoveUserModal.value = true
  selectedUser.value = person
}

const handleEditUer = (user: any) => {
  showEditModal.value = true
  selectedUser.value = user
  payload.value = user

}

const proceedToRemove = () => {
  editUser().then((data) => {
    useNuxtApp().$toast.success('User was edited successfully', {
      autoClose: 5000,
      dangerouslyHTMLString: true,
    });
    showEditModal.value = false
  })
}

const proceedToSuspendUser = () => {
  const payload = {
    isActive: selectedUser.value.isActive ? false : true
  }
  deactivateUser(selectedUser.value.id, payload).then((data) => {
    useNuxtApp().$toast.success('User status was updated successfully', {
      autoClose: 5000,
      dangerouslyHTMLString: true,
    });
    updateUserStatusModal.value = false
  })
}

const selectedStatus = ref('')

const openRemoveUserModal = ref(false)
const updateUserStatusModal = ref(false)

const openDropdownIndex = ref(null);

function toggleDropdown(index: any) {
  openDropdownIndex.value = openDropdownIndex.value === index ? null : index;
}


const indeterminate = computed(() => {
  return (
    selectedPeople.value.length > 0 &&
    selectedPeople.value.length < props.usersList.length
  );
});
const toggleUserStatus = (user: any) => {
  selectedUser.value = user
  updateUserStatusModal.value = true
  if (user.isActive) {
    selectedStatus.value = 'suspend'
  }

  if (!user.isActive) {
    selectedStatus.value = 'reactivate'
  }
};

const generateInitials = (fname: string, lname: string) => {
  return `${fname.charAt(0).toUpperCase()}${lname.charAt(0).toUpperCase()}`;
};
</script>

<style></style>
